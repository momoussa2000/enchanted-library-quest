<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="game.title">The Enchanted Library Quest - FableBox Adventure</title>
    <meta name="description" content="Join Ruby the Dragon, Sage the Wizard, and Scout the Explorer Mouse in a magical learning adventure! Educational puzzles in math, language arts, and science for children ages 4-12.">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- FableBox Branding -->
    <meta name="author" content="FableBox">
    <meta name="publisher" content="FableBox.net">
    <meta name="application-name" content="The Enchanted Library Quest">
    
    <!-- Educational Metadata -->
    <meta name="educational-audience" content="children ages 4-12">
    <meta name="educational-subjects" content="mathematics, language arts, science">
    <meta name="educational-level" content="elementary">
    <meta name="educational-standards" content="Common Core aligned">
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Dyslexia-Friendly Fonts (loaded on demand) -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=OpenDyslexic&display=swap" as="style" id="dyslexia-font-preload">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@300;400;700&display=swap" as="style" id="comic-font-preload">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&display=swap" as="style" id="lexend-font-preload">
    
    <!-- Accessibility & PWA -->
    <meta name="theme-color" content="#8B5CF6">
    <meta name="msapplication-TileColor" content="#8B5CF6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Enchanted Library">
    <meta name="color-scheme" content="light dark">
    
    <!-- App Icons -->
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üè∞</text></svg>">
    <link rel="apple-touch-icon" href="assets/images/icon-192.png">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="screen active">
        <div class="loading-content">
            <div class="magical-logo">
                <h1>The Enchanted Library Quest</h1>
                <div class="sparkles"></div>
            </div>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
            <p class="loading-text">Preparing your magical adventure...</p>
        </div>
    </div>

    <!-- Main Game Container -->
    <div id="game-container">
        <!-- Audio Controls -->
        <div class="audio-controls" aria-label="Audio Controls">
            <button id="mute-btn" class="audio-btn" aria-label="Toggle Sound">
                <span class="audio-icon">üîä</span>
            </button>
        </div>

        <!-- Progress Bar -->
        <div class="progress-header">
            <div class="progress-container">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill"></div>
                </div>
                <div class="progress-stats">
                    <span id="stars-count" class="stars">‚≠ê 0</span>
                    <span id="completion-percent" class="completion">0%</span>
                </div>
            </div>
        </div>

        <!-- Welcome Screen -->
        <div id="welcome-screen" class="screen">
            <div class="screen-content">
                <div class="title-section">
                    <h1 class="game-title">The Enchanted Library Quest</h1>
                    <p class="game-subtitle">Help restore order to the magical library where story characters have escaped!</p>
                </div>
                
                <div class="welcome-illustration">
                    <div class="floating-books"></div>
                    <div class="magical-sparkles"></div>
                </div>
                
                <div class="action-buttons">
                    <button id="start-new-game" class="btn btn-primary" aria-label="Start New Adventure">
                        Start New Adventure
                    </button>
                    <button id="continue-game" class="btn btn-secondary" aria-label="Continue Previous Game" style="display: none;">
                        Continue Quest
                    </button>
                </div>
            </div>
        </div>

        <!-- Character Creation Screen -->
        <div id="character-creation" class="screen">
            <div class="screen-content">
                <h2>Choose Your Magical Companion</h2>
                <p class="instruction-text">Enter your name and select a companion to guide you through the enchanted library:</p>
                
                <div class="name-input-section">
                    <label for="player-name" class="visually-hidden">Enter your name</label>
                    <input type="text" id="player-name" placeholder="Enter your name" maxlength="20" 
                           aria-label="Player name input" class="name-input">
                </div>
                
                <div class="character-selection">
                    <div class="character-option" data-character="dragon" tabindex="0" role="button" aria-label="Select Dragon companion">
                        <div class="character-avatar dragon-avatar"></div>
                        <h3>Ruby the Dragon</h3>
                        <p>Master of numbers and treasure hunting</p>
                        <div class="character-specialty">Math Adventures</div>
                    </div>
                    
                    <div class="character-option" data-character="wizard" tabindex="0" role="button" aria-label="Select Wizard companion">
                        <div class="character-avatar wizard-avatar"></div>
                        <h3>Sage the Wizard</h3>
                        <p>Guardian of words and ancient spells</p>
                        <div class="character-specialty">Language Quests</div>
                    </div>
                    
                    <div class="character-option" data-character="mouse" tabindex="0" role="button" aria-label="Select Explorer Mouse companion">
                        <div class="character-avatar mouse-avatar"></div>
                        <h3>Scout the Explorer</h3>
                        <p>Brave adventurer and nature expert</p>
                        <div class="character-specialty">Science Explorations</div>
                    </div>
                </div>
                
                <div class="difficulty-selection">
                    <h3>Choose Your Challenge Level</h3>
                    <div class="difficulty-options">
                        <label class="difficulty-option">
                            <input type="radio" name="difficulty" value="easy" checked aria-label="Easy difficulty">
                            <span class="difficulty-label">
                                <strong>Apprentice</strong>
                                <small>Ages 4-6</small>
                            </span>
                        </label>
                        <label class="difficulty-option">
                            <input type="radio" name="difficulty" value="medium" aria-label="Medium difficulty">
                            <span class="difficulty-label">
                                <strong>Scholar</strong>
                                <small>Ages 7-9</small>
                            </span>
                        </label>
                        <label class="difficulty-option">
                            <input type="radio" name="difficulty" value="hard" aria-label="Hard difficulty">
                            <span class="difficulty-label">
                                <strong>Master</strong>
                                <small>Ages 10-12</small>
                            </span>
                        </label>
                    </div>
                </div>
                
                <button id="begin-adventure" class="btn btn-primary" disabled aria-label="Begin Adventure">
                    Begin Adventure
                </button>
            </div>
        </div>

        <!-- Story Screen -->
        <div id="story-screen" class="screen">
            <div class="screen-content">
                <div class="story-header">
                    <div class="companion-avatar"></div>
                    <div class="location-info">
                        <h2 id="scene-title">The Grand Library</h2>
                        <p id="scene-location">Enchanted Library - Main Hall</p>
                    </div>
                </div>
                
                <div class="story-content">
                    <div class="story-illustration" id="scene-background"></div>
                    <div class="story-text-container">
                        <p id="story-text" class="story-text"></p>
                        <div id="character-dialogue" class="character-dialogue"></div>
                    </div>
                </div>
                
                <div class="choice-container" id="choice-container">
                    <!-- Dynamic choices will be inserted here -->
                </div>
                
                <div class="action-buttons">
                    <button id="continue-story" class="btn btn-primary" style="display: none;">
                        Continue
                    </button>
                </div>
            </div>
        </div>

        <!-- Puzzle Screen -->
        <div id="puzzle-screen" class="screen">
            <div class="screen-content">
                <div class="puzzle-header">
                    <h2 id="puzzle-title">Challenge Ahead!</h2>
                    <div class="puzzle-info">
                        <span id="puzzle-type" class="puzzle-type"></span>
                        <span id="puzzle-difficulty" class="puzzle-difficulty"></span>
                    </div>
                </div>
                
                <div class="puzzle-content">
                    <div class="puzzle-question-container">
                        <p id="puzzle-question" class="puzzle-question"></p>
                        <div id="puzzle-visual" class="puzzle-visual"></div>
                    </div>
                    
                    <div class="puzzle-input-container" id="puzzle-input-container">
                        <!-- Dynamic puzzle inputs will be inserted here -->
                    </div>
                    
                    <div class="puzzle-feedback" id="puzzle-feedback"></div>
                </div>
                
                <div class="action-buttons">
                    <button id="submit-answer" class="btn btn-primary">
                        Submit Answer
                    </button>
                    <button id="puzzle-hint" class="btn btn-secondary">
                        Get Hint
                    </button>
                    <button id="skip-puzzle" class="btn btn-tertiary">
                        Skip (Costs 1 Star)
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <div class="screen-content">
                <div class="results-header">
                    <h2>Quest Complete!</h2>
                    <div class="celebration-animation"></div>
                </div>
                
                <div class="results-content">
                    <div class="achievement-summary">
                        <div class="stat-item">
                            <span class="stat-label">Stars Earned</span>
                            <span id="final-stars" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Puzzles Solved</span>
                            <span id="puzzles-solved" class="stat-value">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Quest Completion</span>
                            <span id="final-completion" class="stat-value">0%</span>
                        </div>
                    </div>
                    
                    <div class="certificate-section">
                        <h3>Congratulations, Brave Adventurer!</h3>
                        <p>You've helped restore order to the Enchanted Library!</p>
                        <button id="print-certificate" class="btn btn-primary">
                            Print Your Certificate
                        </button>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button id="play-again" class="btn btn-secondary">
                        Play Again
                    </button>
                    <button id="try-different-path" class="btn btn-tertiary">
                        Try Different Path
                    </button>
                </div>
            </div>
        </div>

        <!-- Certificate Modal -->
        <div id="certificate-modal" class="modal">
            <div class="modal-content certificate-content">
                <button class="modal-close" aria-label="Close Certificate">&times;</button>
                <div id="certificate" class="certificate">
                    <div class="certificate-header">
                        <h1>Certificate of Achievement</h1>
                        <div class="certificate-logo">üèÜ</div>
                    </div>
                    <div class="certificate-body">
                        <p class="certificate-text">This certifies that</p>
                        <h2 id="certificate-name" class="certificate-name"></h2>
                        <p class="certificate-text">has successfully completed</p>
                        <h3 class="certificate-quest">The Enchanted Library Quest</h3>
                        <p class="certificate-details">
                            Earning <span id="certificate-stars"></span> stars<br>
                            and demonstrating excellence in<br>
                            <span id="certificate-skills"></span>
                        </p>
                        <div class="certificate-footer">
                            <div class="certificate-date" id="certificate-date"></div>
                            <div class="certificate-signature">FableBox Educational Games</div>
                        </div>
                    </div>
                </div>
                <button id="print-cert-btn" class="btn btn-primary">Print Certificate</button>
            </div>
        </div>
    </div>

    <!-- Particle Effects Container -->
    <div id="particles-container"></div>

    <!-- Screen Reader Announcements -->
    <div id="sr-announcements" class="visually-hidden" aria-live="polite" aria-atomic="true"></div>

    <!-- JavaScript -->
    <!-- Configuration must load first -->
    <script src="js/gameConfig.js"></script>
    
    <!-- Core Systems -->
    <script src="js/accessibility-system.js"></script>
    <script src="js/internationalization-system.js"></script>
    <script src="js/animation-system.js"></script>
    <script src="js/sound-system.js"></script>
    <script src="js/save-system.js"></script>
    <script src="js/achievement-system.js"></script>
    <script src="js/parent-dashboard.js"></script>
    <script src="js/monetization-system.js"></script>
    <script src="js/social-system.js"></script>
    <script src="js/analytics-system.js"></script>
    <script src="js/puzzle-system.js"></script>
    
    <!-- Game Core -->
    <script src="js/game.js"></script>
    <script src="js/scenes.js"></script>
    <script src="js/puzzles.js"></script>
    
    <!-- Initialize Game -->
    <script>
        // Service Worker Registration for Offline Support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('üîß Service Worker registered for offline learning:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New educational content available
                                    if (window.enchantedLibraryGame && window.enchantedLibraryGame.showNotification) {
                                        window.enchantedLibraryGame.showNotification(
                                            'üåü New learning adventures available! Please refresh to update.',
                                            'info',
                                            8000
                                        );
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.warn('üîß Service Worker registration failed:', error);
                    });
            });
        }

        // Initialize the FableBox Educational Game
        document.addEventListener('DOMContentLoaded', function() {
            try {
                if (typeof EnchantedLibraryGame !== 'undefined') {
                    // Create the main game instance
                    window.enchantedLibraryGame = new EnchantedLibraryGame();
                    window.enchantedLibraryGame.initialize();
                    
                    // Initialize accessibility system
                    if (typeof AccessibilitySystem !== 'undefined') {
                        window.accessibilitySystem = new AccessibilitySystem(window.enchantedLibraryGame);
                    }
                    
                    // Initialize internationalization system
                    if (typeof InternationalizationSystem !== 'undefined') {
                        window.i18nSystem = new InternationalizationSystem(window.enchantedLibraryGame);
                    }
                    
                    console.log('üéÆ FableBox Educational Game initialized with full accessibility and internationalization support!');
                    
                } else {
                    throw new Error('EnchantedLibraryGame class not found');
                }
                
            } catch (error) {
                console.error('‚ùå Failed to initialize FableBox educational game:', error);
                
                // Show child-friendly error message
                const errorContainer = document.createElement('div');
                errorContainer.style.cssText = `
                    position: fixed; 
                    top: 0; 
                    left: 0; 
                    width: 100%; 
                    height: 100%; 
                    background: linear-gradient(135deg, #8B5CF6, #60A5FA);
                    display: flex; 
                    align-items: center; 
                    justify-content: center; 
                    z-index: 10000;
                    font-family: 'Nunito', sans-serif;
                `;
                
                errorContainer.innerHTML = `
                    <div style="
                        background: rgba(255,255,255,0.1); 
                        backdrop-filter: blur(10px);
                        color: white; 
                        padding: 40px; 
                        border-radius: 20px; 
                        text-align: center;
                        max-width: 500px;
                        margin: 20px;
                        border: 2px solid rgba(255,255,255,0.2);
                    ">
                        <div style="font-size: 4rem; margin-bottom: 20px;">üè∞</div>
                        <h2 style="margin: 0 0 16px 0; font-size: 1.8rem;">Oops! Magic Loading Problem</h2>
                        <p style="margin: 0 0 24px 0; opacity: 0.9; line-height: 1.5;">
                            The enchanted library needs a moment to prepare your magical learning adventure. 
                            Don't worry - we'll have you learning in no time!
                        </p>
                        <button onclick="window.location.reload()" style="
                            background: rgba(255,255,255,0.2); 
                            border: 2px solid rgba(255,255,255,0.3); 
                            color: white; 
                            padding: 16px 32px; 
                            border-radius: 12px; 
                            cursor: pointer; 
                            font-weight: 600;
                            font-size: 1.1rem;
                            transition: all 0.3s ease;
                            font-family: inherit;
                        " onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            üîÑ Try the Magic Again
                        </button>
                        
                        <div style="margin-top: 32px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2); opacity: 0.7; font-size: 0.9rem;">
                            Educational gaming by <a href="https://fablebox.net" style="color: rgba(255,255,255,0.9);">FableBox</a>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(errorContainer);
            }
        });

        // Progressive Web App Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install suggestion after meaningful engagement
            setTimeout(() => {
                if (window.enchantedLibraryGame && window.enchantedLibraryGame.showNotification) {
                    window.enchantedLibraryGame.showNotification(
                        'üì± Install The Enchanted Library Quest for learning anywhere, anytime - even offline!',
                        'info',
                        6000
                    );
                }
            }, 45000); // Show after 45 seconds of engaged learning
        });
        
        // Handle successful app installation
        window.addEventListener('appinstalled', () => {
            if (window.enchantedLibraryGame && window.enchantedLibraryGame.showNotification) {
                window.enchantedLibraryGame.showNotification(
                    'üéâ Amazing! The Enchanted Library Quest is now installed. Learn anywhere, anytime!',
                    'success'
                );
            }
            
            // Track installation for analytics
            if (window.enchantedLibraryGame && window.enchantedLibraryGame.analyticsSystem) {
                window.enchantedLibraryGame.analyticsSystem.trackEvent('app_installed', {
                    source: 'game_engagement'
                });
            }
        });
    </script>
</body>
</html>
